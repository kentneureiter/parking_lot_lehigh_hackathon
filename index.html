<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>LotSpot</title>
<link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet"/>

<script>
  // Your API Gateway base URL
  const API_BASE = "https://4s39wl9lx7.execute-api.us-east-1.amazonaws.com/prod";
</script>

<style>
  html,body,#app{height:100%;margin:0}
  .login,.app{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .login{display:flex;align-items:center;justify-content:center;height:100%;background:#f6f7f9}
  .card{background:#fff;padding:20px;border-radius:16px;box-shadow:0 10px 25px rgba(0,0,0,.08);width:320px}
  .card h1{margin:0 0 12px 0;font-size:20px}
  .card input{width:100%;padding:10px 12px;margin:8px 0;border:1px solid #e4e6eb;border-radius:10px}
  .card button{width:100%;padding:10px 12px;border:0;border-radius:10px;background:#111827;color:#fff;font-weight:600;cursor:pointer}
  .app{display:none}
  #map{position:absolute;inset:0}
  .legend{position:absolute;top:12px;left:12px;background:#fff;padding:8px 10px;border-radius:12px;box-shadow:0 6px 16px rgba(0,0,0,.1);font-size:12px}
  .dot{display:inline-block;width:10px;height:10px;border-radius:9999px;margin-right:6px;vertical-align:middle}
  .g{background:#16a34a}.y{background:#f59e0b}.r{background:#ef4444}.gr{background:#9ca3af}
  .sheet{position:absolute;left:0;right:0;bottom:0;background:#fff;border-top-left-radius:16px;border-top-right-radius:16px;box-shadow:0 -10px 25px rgba(0,0,0,.12);padding:12px 16px;display:none}
  .row{display:flex;align-items:center;justify-content:space-between;margin:6px 0}
  .pill{font-size:12px;padding:4px 8px;border-radius:9999px}
  .pill.g{background:#dcfce7;color:#166534}.pill.y{background:#fef3c7;color:#92400e}
  .pill.r{background:#fee2e2;color:#991b1b}.pill.gr{background:#e5e7eb;color:#374151}
  .btns a{display:inline-block;margin-right:8px;padding:8px 10px;border-radius:10px;background:#111827;color:#fff;text-decoration:none;font-weight:600}
  .updated{font-size:12px;color:#6b7280}
</style>
</head>

<body>
<div class="login" id="login">
  <div class="card">
    <h1>LotSpot Demo</h1>
    <input id="email" type="email" placeholder="Email"/>
    <input id="pw" type="password" placeholder="Password"/>
    <button id="signin">Sign in</button>
    <p style="font-size:12px;color:#6b7280;margin-top:8px">Demo login (front-end only)</p>
  </div>
</div>

<div class="app" id="app">
  <div id="map"></div>
  <div class="legend">
    <div><span class="dot g"></span>Green ≥ 70%</div>
    <div><span class="dot y"></span>Yellow 30–69%</div>
    <div><span class="dot r"></span>Red &lt; 30%</div>
    <div><span class="dot gr"></span>Gray unknown</div>
  </div>
  <div class="sheet" id="sheet"></div>
</div>

<script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
<script>
const center = [-75.3782, 40.6069]; // Lehigh center

document.getElementById('signin').onclick = () => {
  document.getElementById('login').style.display='none';
  document.getElementById('app').style.display='block';
  init();
};

// helpers
function statusFromRatio(r,t){if(!t||t<=0||isNaN(r))return{cls:'gr',label:'Unknown'};
  if(r>=.7)return{cls:'g',label:'Green'};if(r>=.3)return{cls:'y',label:'Yellow'};return{cls:'r',label:'Red'};}
function percent(r,t){if(!t||t<=0||isNaN(r))return'—';return Math.round(r*100)+'%';}

function sheetHtml(lot,ratio,st){
  const lat=lot.lat,lon=lot.lon;
  const perc=percent(ratio,lot.totalSpots);
  const updated=lot.lastUpdated||'—';
  return `
    <div style="height:6px;width:48px;background:#e5e7eb;border-radius:9999px;margin:8px auto"></div>
    <div class="row"><div style="font-weight:700;font-size:16px">${lot.name}</div><span class="pill ${st.cls}">${st.label}</span></div>
    <div class="row"><div>Spots left:</div><div style="font-weight:700">${lot.availableSpots ?? '—'} / ${lot.totalSpots ?? '—'} (${perc})</div></div>
    <div class="updated">Updated: ${updated}</div>
    <div class="btns" style="margin-top:12px">
      <a href="https://www.google.com/maps/search/?api=1&query=${lat},${lon}" target="_blank">Open in Google Maps</a>
      <a href="maps://?q=${lat},${lon}">Open in Apple Maps</a>
    </div>
    <div class="btns" style="margin-top:10px">
      <a id="btn-park"  href="#" style="background:#16a34a">Park here</a>
      <a id="btn-leave" href="#" style="background:#ef4444">Unpark</a>
    </div>`;
}

async function doAction(action, lot){
  let lat=null,lon=null;
  try {
    const pos = await new Promise((res,rej)=>navigator.geolocation.getCurrentPosition(res,rej,{enableHighAccuracy:true,timeout:5000}));
    lat=pos.coords.latitude; lon=pos.coords.longitude;
  } catch(_) { alert('Could not get GPS — continuing without it.'); }

  const body = { action, lotId: lot.lotId, geofenceId: lot.geofenceId, lat, lon };
  try {
    const r = await fetch(`${API_BASE}/park`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    const j = await r.json();
    alert(j.message || JSON.stringify(j));
    if (action !== 'check') location.reload();
  } catch(err){ alert('Request failed: '+err); }
}

async function init(){
  const style={
    version:8,
    sources:{osm:{type:"raster",tiles:["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],tileSize:256,attribution:"© OpenStreetMap contributors"}},
    layers:[{id:"osm",type:"raster",source:"osm"}]
  };
  const map=new maplibregl.Map({container:'map',style,center,zoom:16});
  map.addControl(new maplibregl.NavigationControl({visualizePitch:true}));
  let data;
  try{
    const res=await fetch(`${API_BASE}/lots`);
    data=await res.json();
  }catch(e){
    alert('Failed to load lots from API. Check URL or CORS.');
    return;
  }
  const lots=(data&&data.lots)||[];
  const sheet=document.getElementById('sheet');

  lots.forEach(lot=>{
    const total=Number(lot.totalSpots||0);
    const avail=Number(lot.availableSpots||0);
    const ratio=total>0?(avail/total):NaN;
    const st=statusFromRatio(ratio,total);
    const el=document.createElement('div');
    Object.assign(el.style,{
      width:'18px',height:'18px',borderRadius:'9999px',border:'2px solid white',
      boxShadow:'0 2px 6px rgba(0,0,0,.25)',cursor:'pointer',
      background:st.cls==='g'?'#16a34a':st.cls==='y'?'#f59e0b':st.cls==='r'?'#ef4444':'#9ca3af'
    });
    new maplibregl.Marker({element:el})
      .setLngLat([Number(lot.lon),Number(lot.lat)])
      .addTo(map);
    el.addEventListener('click',()=>{
      sheet.innerHTML=sheetHtml(lot,ratio,st);
      sheet.style.display='block';
      document.getElementById('btn-park') ?.addEventListener('click',(e)=>{e.preventDefault();doAction('park',lot);});
      document.getElementById('btn-leave')?.addEventListener('click',(e)=>{e.preventDefault();doAction('unpark',lot);});
    });
  });
}
</script>
</body>
</html>
